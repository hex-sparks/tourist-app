<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Interactive Itinerary Map - Chennai</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        #map { width: 100%; height: 75vh; margin: 2rem auto; border-radius: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .custom-marker {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            font-family: Arial, sans-serif;
            transform: translate(-50%, -100%);
        }
        .marker-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #0d9488;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        .marker-label {
            background-color: white;
            color: #10b981;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 6px;
            white-space: nowrap;
            border: 1px solid #10b981;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            user-select: none;
        }
        #routeInfo {
            font-weight: 600;
            color: #2563eb;
            margin: 1rem auto;
            max-width: 600px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 min-h-screen">
    <header class="bg-white/90 backdrop-blur-sm border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <button onclick="window.history.back()" 
                        class="text-gray-600 hover:text-teal-700 bg-transparent px-2 py-1 rounded-md text-sm font-semibold transition-colors duration-200 flex items-center">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Itinerary
                </button>
                <h1 class="text-xl font-extrabold text-teal-700">Select Two Places for Route</h1>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6">
        <p id="routeInfo">Select two places by clicking on their labels to see the route, distance & duration between them.</p>
        <div id="map"></div>
    </main>

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js'></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoibWF0aGVzLS0iLCJhIjoiY21nMjk0YjBwMGx0YTJtczZqYzBiMmVwMSJ9._vuIup5TuAMu7wviNmsWMw';

        const places = [
            { id: 0, name: "Fort St. George", coords: [80.2877, 13.0827], description: "Historic fort and museum." },
            { id: 1, name: "Marina Beach", coords: [80.2830, 13.0500], description: "Longest urban beach in India." },
            { id: 2, name: "Kapaleeshwarar Temple", coords: [80.2575, 13.0388], description: "Iconic Dravidian architecture." },
            { id: 3, name: "San Thome Basilica", coords: [80.2764, 13.0304], description: "Roman Catholic Basilica." },
            { id: 4, name: "Guindy National Park", coords: [80.2376, 13.0151], description: "Urban wildlife park." }
        ];

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [80.25, 13.04],
            zoom: 12
        });

        const bounds = new mapboxgl.LngLatBounds();

        // Store user selections (indexes of source, destination)
        let selectedPlaces = [];

        // Help function to format duration nicely
        function formatDuration(seconds) {
            const minutes = Math.round(seconds / 60);
            if (minutes < 60) return `${minutes} mins`;
            const hours = Math.floor(minutes / 60);
            const remMins = minutes % 60;
            return `${hours} hr ${remMins} mins`;
        }

        // Update route info text on top
        function updateRouteInfo(message) {
            document.getElementById('routeInfo').textContent = message;
        }

        // Create markers with clickable labels for selection
        places.forEach(place => {
            const el = document.createElement('div');
            el.className = 'custom-marker';
            el.innerHTML = `
                <div class="marker-icon"></div>
                <div class="marker-label" style="cursor:pointer;" title="Click to select">${place.name}</div>
            `;

            // Add click handler on label div
            el.querySelector('.marker-label').addEventListener('click', () => {
                if (selectedPlaces.length === 0) {
                    selectedPlaces.push(place);
                    updateRouteInfo(`Selected Start: ${place.name} - Now select destination place.`);
                } else if (selectedPlaces.length === 1) {
                    if (selectedPlaces[0].id === place.id) {
                        updateRouteInfo(`Select a different place as destination.`);
                        return;
                    }
                    selectedPlaces.push(place);
                    updateRouteInfo(`Calculating route from ${selectedPlaces[0].name} to ${selectedPlaces[1].name}...`);
                    calculateRoute(selectedPlaces[0], selectedPlaces[1]);
                } else {
                    selectedPlaces = [place]; // Reset selection
                    updateRouteInfo(`Selected Start: ${place.name} - Now select destination place.`);
                    removeRouteLine();
                }
            });

            new mapboxgl.Marker(el)
                .setLngLat(place.coords)
                .setPopup(new mapboxgl.Popup().setHTML(`<b>${place.name}</b><br>${place.description}`))
                .addTo(map);

            bounds.extend(place.coords);
        });

        map.fitBounds(bounds, { padding: 50, maxZoom: 15 });

        // Variable to store current route source to remove later
        let routeSourceAdded = false;

        function removeRouteLine() {
            if (routeSourceAdded) {
                if (map.getLayer('routeLine')) map.removeLayer('routeLine');
                if (map.getSource('route')) map.removeSource('route');
                routeSourceAdded = false;
            }
        }

        function calculateRoute(startPlace, endPlace) {
            removeRouteLine();

            const coordinates = `${startPlace.coords[0]},${startPlace.coords[1]};${endPlace.coords[0]},${endPlace.coords[1]}`;

            fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${coordinates}?geometries=geojson&access_token=${mapboxgl.accessToken}`)
                .then(res => res.json())
                .then(data => {
                    if (data.code !== 'Ok' || !data.routes || !data.routes.length) {
                        updateRouteInfo('Could not calculate route. Please try again.');
                        return;
                    }

                    const routeData = data.routes[0];
                    const distanceKm = (routeData.distance / 1000).toFixed(2);
                    const durationText = formatDuration(routeData.duration);

                    updateRouteInfo(`Route: ${startPlace.name} âž” ${endPlace.name} | Distance: ${distanceKm} km | Estimated time: ${durationText}`);

                    map.addSource('route', {
                        type: 'geojson',
                        data: {
                            type: 'Feature',
                            geometry: routeData.geometry
                        }
                    });

                    map.addLayer({
                        id: 'routeLine',
                        type: 'line',
                        source: 'route',
                        layout: {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        paint: {
                            'line-color': '#2563eb',
                            'line-width': 6,
                            'line-opacity': 0.8
                        }
                    });

                    routeSourceAdded = true;

                    // Adjust map bounds to show route entirely
                    const coords = routeData.geometry.coordinates;
                    const routeBounds = new mapboxgl.LngLatBounds();
                    coords.forEach(coord => routeBounds.extend(coord));
                    map.fitBounds(routeBounds, { padding: 60, maxZoom: 15 });
                })
                .catch(() => {
                    updateRouteInfo('Error fetching route data. Check your internet connection.');
                });
        }
    </script>
</body>
</html>
